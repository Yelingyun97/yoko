## 学习记录

智能指针需要注意的地方的基本都在代码注释中写了，比较有意思的地方应该是独占指针的reset方法和release方法在实现其他成员函数时可以重复利用，共享指针中的swap方法也是如此。

顺便重新认识了一下C++的左右值，学习了一下引用折叠和完美转发相关的知识，说实话被右值引用搞得有点头大，目前感觉对转发的理解还不到位，看了一天多了，查了各种资料，是越看越乱，暂时先这样吧，或许哪天就突然理解了。

先随便做点记录吧（好像和智能指针没啥关系）。

### 左右值相关

左值右值是表达式的属性。C++17之前对左右值的概念的定义很模糊，之后明确了这些概念，进一步细分了表达式的值类别。将表达式分为泛左值和右值，泛左值又分为左值和将亡值，右值又分为将亡值和纯右值，将亡值是泛左值和右值的交集。将亡值的定义如下：

* 第一种是使用类型转换将泛左值转换成右值；

* 第二种是临时量的实质化，例如X().a这样的。

一些注意的点：

* ++i将变量i递增后返回i，属于左值；

* i++将i先拷贝到一个临时量后递增，然后返回临时量，属于右值；

* 通常来说，字面值常量属于左值，但字符串常量例外，它属于左值；

* 右值引用本身是左值，还有一点令人费解的是，左值能够取地址，右值引用是左值当然能够取地址，但是函数的返回值如果是左值引用的话是能取地址的的，是右值引用却不能取地址，如下所示：

  > ```c++
  > // 接收一个int类型的右值
  > void foo(int &&i) {
  >     std::cout << i << std::endl;
  > }
  > 
  > int &&foo2(int &&i) {
  >     return static_cast<int &&>(i);
  > }
  > 
  > int &foo3(int &&i) {
  >     return static_cast<int &&>(i);
  > }
  > 
  > int main() {
  > 	int &&i = 4;
  > 	foo(i);		// 编译不通过，报的错误是int类型的右值不能绑定到int类型的左值，说明右值引用是左值
  >     &foo2(1);	// 编译不通过，foo2返回值是右值引用，但是却返回的右值，或许这也是std::forward能够实现完美转发的原因之一，
  >     			// 如果说右值引用是左值，返回的也是左值的话，那么即使std::forward将传入的参数转化成右值后，返回的还是左值
  >     &foo3(1);	// 编译通过，说明
  > }
  > ```

### 三五法则

就是说一般要自定义析构方法的类，通常也要自己定义拷贝构造和拷贝赋值，如果需要自己实现析构函数，说明类中一般会有指针，且动态分配了内存，这时候就要考虑深拷贝和浅拷贝的问题，编译器合成的拷贝构造和拷贝赋值只是做了浅拷贝，这样多个对象共用一块内存会有风险。C++11之后还多了移动构造和移动赋值，这些类成员函数基本绑定一块了，可能这就是三五法则名字由来吧。还有就是移动构造和移动拷贝通常来说是不允许抛出异常的，要是抛出异常，内存没移动完毕，内存会有两个对象各占一部分，会导致内存泄漏，通常是要加noexcept关键字的，析构函数编译器一般会隐式加上noexcept。

### 引用折叠

引用折叠好像没啥好说的，就拷贝一份C++primer中的概念吧：

> 正常情况下，C++是不允许定义一个引用的引用，<u>但是可以通过类型别名或者模板类型参数间接定义，这种间接创建的引用的引用会形成“折叠”</u>。对于一个给定类型X，引用折叠的规则如下：
> * X& &、X& &&和X&& &都折叠成类型X&
> * X&& &&折叠成X&&

所谓万能引用就是绑定模板参数的右值引用，也就是T&&，按书上说的万能引用能保存函数实参的所有性质，也就是const以及左值/右值的属性。

### 转发

转发相关的看过一些，感觉还没理清楚到能讲出来的地步。。。

## 参考

边看up主[小妖什么](https://space.bilibili.com/13791824)的讲解边敲的，基本就是照着up主的敲的，目前的实现还不能将基类指针指向派生类对象，有时间再看看。下面贴下up主的视频链接以及他的git仓库，里面还有线程池和安全队列的实现，个人觉得up讲的真的很好。

* [简单实现shared_ptr](https://www.bilibili.com/video/BV1uS4y117zo/?share_source=copy_web&vd_source=56e0e0c96bf6f17101c5f34f02017dd2)

* [简单实现unique_ptr](https://www.bilibili.com/video/BV1nF411H7kd/?share_source=copy_web&vd_source=56e0e0c96bf6f17101c5f34f02017dd2)

* [silenke](https://github.com/silenke/interview_mini_questions)

* [都要毕业了，C/C++ 的左值和右值还傻傻分不清楚?](https://www.bilibili.com/video/BV1Sg411276U/?share_source=copy_web&vd_source=56e0e0c96bf6f17101c5f34f02017dd2)，这个系列的视频讲的也很好，目前就看了第左右值到转发相关的，其他还没看，up还是个的佬